Goals
^^^^^
It would be useful to have a tool that can be used for building Tor
Bundle Browser, and packages for any of the Tor components.

Tor Bundle Browser
++++++++++++++++++
In the current build process for the Tor Bundle Browser, gitias is used
to :

- create and start an Ubuntu VM in KVM or LXC

- install build dependencies in the VM

- copy the sources files in the VM and start the build

The parts that are not done by gitian but by a shellscript based wrapper
around gitian:

- initial clone of the git repository containing the sources
  (fetch-inputs.sh)

- git tag gpg signature check (verify-tags.sh)

- download tarballs from mirrors, and verify gpg signature or sha256sum
  (fetch-inputs.sh)

Improvement that can be done from the current process:

- some informations are duplicated in different places, such as git URLs
  (both in gitian descriptor and in fetch-inputs.sh)

- linux, mac and windows gitian descriptors are separate, so part of
  them are duplicating some informations. It would be better to be able
  to share the parts that are common on all OSs.

- build process is not very modular. It is not possible or simple to
  build only some components.

- the build process can currently only be run from Ubuntu

- the current process requires using git tags if gpg signature
  verification is wanted. It could be useful to be able to use gpg
  signed commits instead.

To solve this, we can have a tool that handle both the tasks currently
done by gitian, and the tasks currently done by shellscript wrappers:

- store in a single descriptor the build instructions, build dependencies,
  git URL, tarball URLs, gpg keyring file, sha256sum, etc ... and have
  all the operations done by the tool. This should remove the need for
  wrappers.

- create a separate descriptor for each software that we build, so that
  they can be built separately. The tool should be able to manage
  dependencies between separate builds to create a bundle of different
  software.

- a templating system allows us to have some variables and use them at
  different places. This allows us to have a common build descriptor
  for all OSs, and use conditional templating instructions where the
  process differ between the different OSs.

A prototype to show a possible build process is available.

Packages
++++++++
[[proposal-continuous-packaging]]
In addition to building the Tor Browser Bundle, we also need to build
some rpm or Debian packages for different components. Some of them are
also included in the Tor Browser Bundle.

To be able to do continuous packaging, we need a tool that would allow
us to produce an rpm or Debian package from a git commit. In the
jenkins/tools.git repository, some shell scripts are used to produce
Tor Debian packages from the latest commit.

To avoid duplicating build instructions, URLs, gpg keyring and other
infos, it would be useful if a single tool was able to produce the Tor
Browser Bundle and also individual packages for some of the components.

Prototype and current status
^^^^^^^^^^^^^^^^^^^^^^^^^^^^
I have created recently a tool that could be used to build Bundle, and
Debian and rpm packages : http://burps.boklm.eu/[burps (build & upload
reproducible packaging system)].

It currently has the following features:

- build software from a git repository, with tag signature verification
  and/or commit signature verification

- download files from an URL, and check gpg signature, or sha256sum

- use build result from the build of an other component

- build on a remote host or VM

- build rpm or Debian packages, or tarballs

- define variables in the descriptors, and use them anywhere using
  template instructions

- override some variables on command line by selecting build targets.

It is currently missing the following features from gitian:

- creation and start/stop of the Ubuntu build VMs. We can keep the
  gitian scripts for that, and improve them later.

- definition of the build dependencies in the descriptor and installation.
  This should not be a lot of work to add this feature.

A prototype of the build descriptor for a simplified version of Tor
Bundle Browser is available : TODO.
